<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>File Converter Pro</title>

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Libs (tetap sama) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg-a:#0f172a;
      --bg-b:#020617;
      --accent:#4f46e5;
      --accent-soft:#6366f1;
      --accent-2:#22c55e;
      --card:#020617;
      --card-soft:rgba(15,23,42,0.85);
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --radius-lg:22px;
      --radius-md:14px;
      --shadow-soft:0 22px 60px rgba(15,23,42,.65);
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
      background:radial-gradient(circle at top,#1f2937 0,transparent 60%),
                 radial-gradient(circle at bottom,#111827 0,transparent 60%),
                 linear-gradient(135deg,var(--bg-a),var(--bg-b));
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:20px;
    }

    /* dekor backlight */
    body::before,
    body::after{
      content:'';
      position:fixed;
      width:420px;
      height:420px;
      border-radius:999px;
      filter:blur(80px);
      opacity:.12;
      z-index:-1;
    }
    body::before{
      background:#4f46e5;
      top:-80px; left:-80px;
    }
    body::after{
      background:#22c55e;
      bottom:-80px; right:-80px;
    }

    .shell{
      width:100%;
      max-width:1040px;
    }

    /* NAV */
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:34px; height:34px;
      border-radius:12px;
      background:conic-gradient(from 140deg,#4f46e5,#22c55e,#06b6d4,#4f46e5);
      display:flex;align-items:center;justify-content:center;
      color:#fff;
      font-size:18px;
      font-weight:700;
      box-shadow:0 10px 30px rgba(15,23,42,.7);
    }
    .brand-title{
      font-weight:600;
      font-size:18px;
      letter-spacing:.02em;
    }
    .brand-sub{
      font-size:12px;
      color:var(--muted);
    }
    .tag-beta{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .tag-dot{
      width:6px;height:6px;border-radius:999px;background:#22c55e;
    }

    /* HERO */
    .hero{
      text-align:left;
      margin-bottom:20px;
    }
    .hero-title{
      font-size:2rem;
      line-height:1.2;
      margin-bottom:6px;
    }
    .hero-title span{
      background:linear-gradient(135deg,#e5e7eb,#a5b4fc);
      -webkit-background-clip:text;
      color:transparent;
    }
    .hero-sub{
      font-size:.98rem;
      color:var(--muted);
      max-width:520px;
    }

    /* LAYOUT UTAMA */
    .main-grid{
      display:grid;
      grid-template-columns:minmax(0,2.1fr) minmax(0,1.4fr);
      gap:18px;
      align-items:flex-start;
    }

    .card{
      background:radial-gradient(circle at top left,rgba(248,250,252,.02),transparent 55%),
                 var(--card-soft);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,.22);
      box-shadow:var(--shadow-soft);
      padding:20px 20px 18px;
      backdrop-filter:blur(24px);
    }

    /* AREA KONVERTER */
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
      gap:8px;
    }
    .card-header-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card-title{
      font-size:1.02rem;
      font-weight:600;
    }
    .card-sub{
      font-size:.85rem;
      color:var(--muted);
    }
    .pill-soft{
      padding:4px 9px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(75,85,99,.8);
      font-size:.78rem;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill-soft span.badge-dot{
      width:7px;height:7px;border-radius:999px;background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,.18);
    }

    .bar{
      display:grid;
      gap:10px;
      grid-template-columns:minmax(0,1.4fr) minmax(0,1.1fr) max-content;
      align-items:stretch;
      margin-bottom:10px;
    }
    .control{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    input[type=file],
    select{
      width:100%;
      padding:9px 11px;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:rgba(15,23,42,.92);
      color:var(--text);
      font-size:.9rem;
      outline:none;
      transition:border-color .16s, box-shadow .16s, background .16s;
    }
    input[type=file]:hover,
    select:hover{
      border-color:#4f46e5;
      box-shadow:0 0 0 1px rgba(79,70,229,.40);
    }

    .btn{
      padding:10px 18px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease, background .15s;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      color:#f9fafb;
      box-shadow:0 12px 30px rgba(79,70,229,.55);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      filter:brightness(1.02);
    }
    .btn-outline{
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.6);
      color:var(--text);
    }
    .btn-ghost{
      background:transparent;
      border:1px solid rgba(55,65,81,.8);
      color:var(--muted);
    }
    .btn-ghost:hover,
    .btn-outline:hover{
      border-color:#4f46e5;
      color:#e5e7eb;
    }

    .btn-icon{
      font-size:1.1rem;
    }

    #options{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(55,65,81,.9);
    }

    .options-grid{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(3,minmax(0,1fr));
      margin-top:4px;
    }
    .field label{
      display:block;
      font-size:.78rem;
      font-weight:500;
      color:var(--muted);
      margin-bottom:4px;
    }
    .field input,
    .field select{
      width:100%;
      padding:8px 10px;
      border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:rgba(15,23,42,.92);
      color:var(--text);
      font-size:.86rem;
      outline:none;
      transition:border-color .16s, box-shadow .16s, background .16s;
    }
    .field input:focus,
    .field select:focus{
      border-color:#4f46e5;
      box-shadow:0 0 0 1px rgba(79,70,229,.5);
    }

    .hint{
      margin-top:10px;
      font-size:.82rem;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:7px;
    }
    .hint-icon{
      font-size:.9rem;
      opacity:.85;
    }

    .actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:12px;
    }

    #output{
      margin-top:14px;
      padding-top:10px;
      border-top:1px solid rgba(31,41,55,.9);
      display:grid;
      gap:10px;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    }

    canvas{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(31,41,55,.9);
      background:#020617;
    }

    a.download-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-decoration:none;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#f9fafb;
      padding:8px 10px;
      border-radius:999px;
      margin-top:8px;
      font-size:.85rem;
      font-weight:500;
      box-shadow:0 10px 26px rgba(22,163,74,.45);
    }

    a.download-link::before{
      content:'â¬‡';
      font-size:.9rem;
    }

    /* SIDEBAR INFO */
    .sidebar{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .side-card{
      background:radial-gradient(circle at top left,rgba(248,250,252,.02),transparent 55%),
                 rgba(15,23,42,.92);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,.16);
      padding:16px 16px 14px;
      backdrop-filter:blur(18px);
    }
    .side-title{
      font-size:.95rem;
      font-weight:600;
      margin-bottom:4px;
    }
    .side-sub{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:8px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .chip{
      font-size:.78rem;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(15,23,42,1);
      border:1px solid rgba(55,65,81,.9);
      color:var(--muted);
    }
    .side-list{
      list-style:none;
      margin-top:6px;
      font-size:.8rem;
      color:var(--muted);
    }
    .side-list li{
      display:flex;
      align-items:flex-start;
      gap:6px;
      margin-bottom:4px;
    }
    .side-list li span{
      margin-top:2px;
    }

    footer{
      margin-top:18px;
      font-size:.75rem;
      color:rgba(148,163,184,.8);
      text-align:center;
    }

    /* RESPONSIVE */
    @media (max-width:900px){
      .main-grid{
        grid-template-columns:minmax(0,1fr);
      }
    }
    @media (max-width:640px){
      body{padding:14px;}
      .hero-title{font-size:1.65rem;}
      .bar{
        grid-template-columns:1fr;
      }
      .options-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media (max-width:460px){
      .options-grid{
        grid-template-columns:1fr;
      }
      .card{
        padding:16px 14px 14px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- NAV -->
    <header class="nav">
      <div class="brand">
        <div class="brand-logo">F</div>
        <div>
          <div class="brand-title">File Converter Pro</div>
          <div class="brand-sub">All-in-one file & PDF toolkit</div>
        </div>
      </div>
      <div class="tag-beta">
        <span class="tag-dot"></span>
        <span>Runs 100% in your browser</span>
      </div>
    </header>

    <!-- HERO TEXT -->
    <section class="hero">
      <h1 class="hero-title">
        Ubah & kelola <span>file kamu</span> langsung dari browser.
      </h1>
      <p class="hero-sub">
        Konversi PDF â‡„ gambar, TXT â‡¢ PDF, gabung/pisah/rotate/watermark PDF, kompres & konversi gambar, hingga OCR â€“ tanpa upload ke server.
      </p>
    </section>

    <!-- MAIN GRID -->
    <main class="main-grid">
      <!-- KIRI: KONVERTER -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-left">
            <div class="card-title">Mulai konversi</div>
            <div class="card-sub">Pilih file, tentukan tipe konversi, lalu klik <b>Konversi Sekarang</b>.</div>
          </div>
          <div class="pill-soft">
            <span class="badge-dot"></span>
            <span>Mendukung banyak file sekaligus</span>
          </div>
        </div>

        <div class="bar">
          <div class="control">
            <input type="file" id="fileInput" multiple/>
          </div>

          <select id="convertType">
            <option value="pdf2png">PDF âžœ PNG (per halaman)</option>
            <option value="txt2pdf">TXT âžœ PDF</option>
            <option value="imgConvert">Gambar âžœ JPG/PNG/WebP/HEIC</option>
            <option value="imgCompress">Kompres Gambar</option>
            <option value="jpg2png">JPG âžœ PNG (cepat)</option>
            <option value="png2jpg">PNG âžœ JPG (cepat)</option>
            <option value="pdfMerge">Gabung beberapa PDF</option>
            <option value="pdfSplit">Pisah PDF (rentang halaman)</option>
            <option value="pdfRotate">Rotate halaman PDF</option>
            <option value="pdfWatermark">Watermark teks di PDF</option>
            <option value="pdfExtractImages">Ekstrak halaman PDF â†’ PNG</option>
            <option value="ocrImage">OCR Gambar â†’ Teks (beta)</option>
          </select>

          <button class="btn btn-primary" id="convertBtn">
            <span class="btn-icon">âš¡</span>
            <span>Konversi Sekarang</span>
          </button>
        </div>

        <!-- Opsi dinamis -->
        <div id="options"></div>

        <div class="hint">
          <span class="hint-icon">ðŸ’¡</span>
          <span>Bisa pilih banyak file sekaligus. Gunakan <b>Zip Hasil</b> untuk mengunduh semua output dalam satu paket.</span>
        </div>

        <div class="actions">
          <button class="btn btn-outline" id="zipBtn" title="Kumpulkan semua hasil jadi satu ZIP">
            Zip Hasil
          </button>
          <button class="btn btn-ghost" id="clearBtn" title="Bersihkan area hasil">
            Bersihkan hasil
          </button>
        </div>

        <div id="output"></div>
      </section>

      <!-- KANAN: INFO -->
      <aside class="sidebar">
        <div class="side-card">
          <div class="side-title">Mode konversi populer</div>
          <p class="side-sub">Pilihan paling sering dipakai pengguna untuk kebutuhan harian.</p>
          <div class="chips">
            <span class="chip">PDF âžœ PNG halaman</span>
            <span class="chip">Gabung beberapa PDF</span>
            <span class="chip">Kompres gambar besar</span>
            <span class="chip">TXT âžœ PDF rapi</span>
          </div>
        </div>

        <div class="side-card">
          <div class="side-title">Tips hasil maksimal</div>
          <ul class="side-list">
            <li><span>â€¢</span><span>Gunakan skala 2â€“3x saat render PDF âžœ PNG untuk hasil tajam.</span></li>
            <li><span>â€¢</span><span>Untuk kompres gambar, mulai dari kualitas 0.8 lalu sesuaikan.</span></li>
            <li><span>â€¢</span><span>OCR berjalan terbaik pada gambar teks yang jelas & tidak blur.</span></li>
          </ul>
        </div>
      </aside>
    </main>

    <footer>
      File Converter Pro Â· berjalan di sisi klien Â· tidak menyimpan file kamu di server.
    </footer>
  </div>

  <script>
    // ===== Helpers UI =====
    const $ = (q,root=document)=>root.querySelector(q);
    const output = $('#output'); const options = $('#options');
    const zip = new JSZip();
    const pad = (n, scheme) => (scheme + n).slice(-scheme.length);
    const parseRanges = (str, max)=>{
      if(!str) return Array.from({length:max},(_,i)=>i+1);
      const s=new Set();
      for(const part of str.split(',')){
        if(part.includes('-')){ let [a,b]=part.split('-').map(n=>parseInt(n.trim(),10));
          if(isNaN(a)||isNaN(b)) continue; if(a>b) [a,b]=[b,a]; for(let i=a;i<=b;i++) s.add(i);
        }else{ const n=parseInt(part.trim(),10); if(!isNaN(n)) s.add(n); }
      }
      return Array.from(s).filter(n=>n>=1&&(!max||n<=max)).sort((a,b)=>a-b);
    }
    const createLink=(blobOrUrl,name,previewEl)=>{
      const wrap=document.createElement('div');
      if(previewEl) wrap.appendChild(previewEl);
      const a=document.createElement('a');
      a.className='download-link'; a.download=name;
      a.href = blobOrUrl instanceof Blob ? URL.createObjectURL(blobOrUrl) : blobOrUrl;
      a.textContent = name;
      wrap.appendChild(a); output.appendChild(wrap);
    }

    // ===== Opsi Dinamis (tanpa tumpang tindih) =====
    const renderOptions=()=>{
      const type=$('#convertType').value;
      let html='';
      const wrapStart = '<div class="options-grid">';
      const wrapEnd = '</div>';

      if(type==='pdf2png'){
        html = wrapStart +
          '<div class="field"><label>Skala render</label><input id="scale" type="number" value="2" step="0.5" min="0.5"/></div>'+
          '<div class="field"><label>Halaman (mis. 1-3,5)</label><input id="pageRange" type="text" placeholder="kosong = semua"/></div>'+
          '<div class="field"><label>Nama dasar</label><input id="baseName" type="text" value="halaman"/></div>' +
          wrapEnd;
      } else if(type==='txt2pdf'){
        html = wrapStart +
          '<div class="field"><label>Ukuran font</label><input id="fontSize" type="number" value="12" min="8" max="32"/></div>'+
          '<div class="field"><label>Margin (mm)</label><input id="margin" type="number" value="15" min="5" max="40"/></div>'+
          '<div class="field"><label>Orientasi</label><select id="orientation"><option value="p">Potret</option><option value="l">Lanskap</option></select></div>' +
          wrapEnd;
      } else if(type==='imgConvert' || type==='imgCompress'){
        html = wrapStart +
          '<div class="field"><label>Format keluaran</label><select id="imgFormat"><option value="image/jpeg">JPG</option><option value="image/png" selected>PNG</option><option value="image/webp">WEBP</option></select></div>'+
          '<div class="field"><label>Kualitas (JPG/WEBP)</label><input id="quality" type="number" value="0.92" step="0.02" min="0.2" max="1"/></div>'+
          '<div class="field"><label>Lebar px (0 = asli)</label><input id="width" type="number" value="0" min="0"/></div>' +
          wrapEnd;
      } else if(type==='pdfSplit'){
        html = wrapStart + '<div class="field" style="grid-column:1/-1"><label>Rentang (mis. 1-3,5)</label><input id="splitRanges" type="text" placeholder="contoh: 1-2,4"/></div>' + wrapEnd;
      } else if(type==='pdfRotate'){
        html = wrapStart +
          '<div class="field"><label>Derajat</label><select id="rotateDeg"><option>90</option><option>180</option><option>270</option></select></div>'+
          '<div class="field"><label>Halaman (kosong = semua)</label><input id="rotPages" type="text"/></div>' +
          wrapEnd;
      } else if(type==='pdfWatermark'){
        html = wrapStart +
          '<div class="field"><label>Teks watermark</label><input id="wmText" type="text" value="CONFIDENTIAL"/></div>'+
          '<div class="field"><label>Opacity (0â€“1)</label><input id="wmOpacity" type="number" value="0.15" step="0.05" min="0.05" max="1"/></div>' +
          wrapEnd;
      } else {
        html='';
      }
      options.innerHTML = html;
    }
    $('#convertType').addEventListener('change',renderOptions);
    renderOptions();

    // ===== ZIP & CLEAR =====
    $('#zipBtn').addEventListener('click', async ()=>{
      if(Object.keys(zip.files).length===0){ alert('Belum ada file hasil.'); return; }
      const blob = await zip.generateAsync({type:'blob'}); saveAs(blob,'hasil_konversi.zip');
    });
    $('#clearBtn').addEventListener('click', ()=>{ output.innerHTML=''; zip.files={}; });

    // ===== LOGIKA KONVERSI (tetap sama) =====
    document.getElementById('convertBtn').addEventListener('click', async ()=>{
      const type = $('#convertType').value;
      const fileInput = $('#fileInput');
      output.innerHTML = '';
      if(!fileInput.files.length){ alert('Pilih dulu file-nya!'); return; }
      const files = fileInput.files;

      try{
        if (type === 'pdf2png') {
          for (const f of files){
            const typedarray = new Uint8Array(await f.arrayBuffer());
            const pdf = await pdfjsLib.getDocument({data:typedarray}).promise;
            const scale = parseFloat($('#scale')?.value||'2');
            const base = $('#baseName')?.value || 'halaman';
            const pages = parseRanges($('#pageRange')?.value, pdf.numPages);
            for (const p of pages){
              const page = await pdf.getPage(p);
              const viewport = page.getViewport({ scale });
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.height = viewport.height; canvas.width = viewport.width;
              await page.render({ canvasContext: context, viewport }).promise;
              const blob = await new Promise(res=>canvas.toBlob(res,'image/png'));
              const name = `${base}_${pad(p,'000')}.png`;
              zip.file(name, blob); createLink(blob, name, canvas);
            }
          }
        }
        else if (type === 'txt2pdf') {
          const { jsPDF } = window.jspdf;
          for (const [idx,f] of Array.from(files).entries()){
            const text = await f.text();
            const fontSize = parseInt($('#fontSize')?.value||'12',10);
            const margin = parseInt($('#margin')?.value||'15',10);
            const orient = $('#orientation')?.value==='l'?'l':'p';
            const doc = new jsPDF({orientation:orient, unit:'mm', format:'a4'});
            doc.setFontSize(fontSize);
            const pageWidth = doc.internal.pageSize.getWidth();
            const usable = pageWidth - margin*2;
            const lines = doc.splitTextToSize(text, usable);
            let y = margin; const lineHeight = fontSize * 0.5 + 2;
            lines.forEach(ln=>{ if(y>doc.internal.pageSize.getHeight()-margin){doc.addPage();y=margin} doc.text(ln, margin, y); y+=lineHeight; });
            const blob = doc.output('blob');
            const name = `${f.name.replace(/\.[^.]+$/,'') || 'file'}_${pad(idx+1,'000')}.pdf`;
            zip.file(name, blob); createLink(blob, name);
          }
        }
        else if (type === 'imgConvert' || type === 'imgCompress' || type==='jpg2png' || type==='png2jpg') {
          const fmt = type==='jpg2png' ? 'image/png' : type==='png2jpg' ? 'image/jpeg' : ($('#imgFormat')?.value || 'image/png');
          const q = Math.min(1, Math.max(0.2, parseFloat($('#quality')?.value||'0.92')));
          const w = parseInt($('#width')?.value||'0',10);
          for(const [i,f] of Array.from(files).entries()){
            let srcBlob = f;
            if(/\.heic$/i.test(f.name)){ try{ srcBlob = await heic2any({blob:f, toType:'image/jpeg', quality:q}); }catch(e){ console.warn('HEIC gagal',e); continue; } }
            const dataUrl = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(srcBlob) });
            const img = new Image(); await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=dataUrl; });
            const canvas = document.createElement('canvas');
            const scale = w>0 ? (w/img.width) : 1;
            canvas.width = Math.round(img.width*scale); canvas.height = Math.round(img.height*scale);
            canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
            const blob = await new Promise(res=>canvas.toBlob(res, fmt, q));
            const ext = fmt.split('/')[1].replace('jpeg','jpg');
            const name = `${(f.name.replace(/\.[^.]+$/,''))}_${pad(i+1,'000')}.${ext}`;
            zip.file(name, blob); createLink(blob, name, canvas);
          }
        }
        else if (type === 'pdfMerge') {
          const pdfDoc = await PDFLib.PDFDocument.create();
          for(const f of files){
            const donor = await PDFLib.PDFDocument.load(await f.arrayBuffer());
            const copied = await pdfDoc.copyPages(donor, donor.getPageIndices());
            copied.forEach(p=>pdfDoc.addPage(p));
          }
          const out = await pdfDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
          createLink(blob, 'gabungan.pdf'); zip.file('gabungan.pdf', blob);
        }
        else if (type === 'pdfSplit') {
          if(files.length!==1){ alert('Pilih 1 file PDF untuk dipisah.'); return; }
          const src = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
          const total = src.getPageCount();
          const ranges = parseRanges($('#splitRanges')?.value, total);
          const chunks=[]; let cur=[]; let prev=null;
          for(const p of ranges){ if(prev===null||p===prev+1){cur.push(p-1)} else {chunks.push(cur); cur=[p-1]} prev=p } if(cur.length) chunks.push(cur);
          let idx=1; for(const ch of chunks){
            const outDoc = await PDFLib.PDFDocument.create();
            const copied = await outDoc.copyPages(src, ch); copied.forEach(p=>outDoc.addPage(p));
            const out = await outDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
            const name = `split_${pad(idx++,'000')}.pdf`; zip.file(name, blob); createLink(blob, name);
          }
        }
        else if (type === 'pdfRotate') {
          if(files.length!==1){ alert('Pilih 1 file PDF.'); return; }
          const deg = parseInt($('#rotateDeg')?.value||'90',10);
          const pagesSel = parseRanges($('#rotPages')?.value);
          const pdfDoc = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
          const pages = pdfDoc.getPages();
          pages.forEach((p,idx)=>{ const n=idx+1; if(!pagesSel.length || pagesSel.includes(n)){ p.setRotation(PDFLib.degrees(((p.getRotation().angle||0)+deg)%360)); }});
          const out = await pdfDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
          createLink(blob, 'rotated.pdf'); zip.file('rotated.pdf', blob);
        }
        else if (type === 'pdfWatermark') {
          if(files.length!==1){ alert('Pilih 1 file PDF.'); return; }
          const text = $('#wmText')?.value || 'CONFIDENTIAL';
          const opacity = Math.max(0.05, Math.min(1, parseFloat($('#wmOpacity')?.value||'0.15')));
          const pdfDoc = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
          pdfDoc.getPages().forEach(p=>{ const {width,height}=p.getSize(); p.drawText(text,{x:width/4,y:height/2,size:48,rotate:PDFLib.degrees(-30),color:PDFLib.rgb(0.2,0.2,0.2),opacity}); });
          const out = await pdfDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
          createLink(blob, 'watermarked.pdf'); zip.file('watermarked.pdf', blob);
        }
        else if (type === 'pdfExtractImages') {
          for (const f of files){
            const buf = await f.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data:new Uint8Array(buf)}).promise;
            for(let i=1;i<=pdf.numPages;i++){
              const page = await pdf.getPage(i);
              const viewport = page.getViewport({ scale: 2 });
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.height = viewport.height; canvas.width = viewport.width;
              await page.render({ canvasContext: ctx, viewport }).promise;
              const blob = await new Promise(res=>canvas.toBlob(res,'image/png'));
              const name = `page_${pad(i,'000')}.png`; zip.file(name, blob); createLink(blob, name, canvas);
            }
          }
        }
        else if (type === 'ocrImage') {
          for(const [i,f] of Array.from(files).entries()){
            const { data } = await Tesseract.recognize(f, 'eng+ind');
            const txtBlob = new Blob([data.text],{type:'text/plain'});
            const name = `ocr_${pad(i+1,'000')}.txt`; zip.file(name, txtBlob); createLink(txtBlob, name);
          }
        }
      }catch(e){ console.error(e); alert('Terjadi kesalahan. Cek konsol (F12).'); }
    });
  </script>
</body>
</html>
