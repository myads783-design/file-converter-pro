<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>File Converter Pro</title>

  <!-- Libs (tetap sama) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg-a:#667eea; --bg-b:#764ba2;
      --card:#fff; --text:#333; --muted:#666;
      --accent:#667eea; --accent-2:#764ba2;
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg-a),var(--bg-b));
      color:#fff; margin:0; padding:0; text-align:center;
    }
    header{padding:40px 20px}
    h1{font-size:2.2rem; margin:.25rem 0 10px}
    p.lead{font-size:1.05rem; color:#f1f1f1}

    .container{
      max-width:860px; margin:20px auto 40px; padding:28px;
      background:var(--card); color:var(--text);
      border-radius:var(--radius); box-shadow:0 5px 20px rgba(0,0,0,.2);
      text-align:left;
    }

    /* BAR UTAMA */
    .bar{
      display:grid; gap:12px; align-items:center;
      grid-template-columns:1fr max-content max-content;
    }
    .bar .control{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .bar select, .bar input[type=file], .btn{
      padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; font-size:1rem;
    }
    .btn{
      background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight:600;
      transition:.2s; padding:10px 16px;
    }
    .btn:hover{filter:brightness(.95)}
    .btn.secondary{background:#e5e7eb; color:#111}
    .btn.outline{background:#fff; color:var(--accent); border:1px solid var(--accent)}

    /* OPSI BAWAH */
    #options{
      margin-top:18px;
      padding-top:14px;
      border-top:1px dashed #e5e7eb;
    }
    .options-grid{
      display:grid; gap:14px;
      grid-template-columns:repeat(3, minmax(140px,1fr));
    }
    .field label{
      display:block; font-size:.9rem; font-weight:600; color:var(--muted); margin-bottom:6px;
    }
    .field input, .field select{
      width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:10px; font-size:1rem;
      background:#fff; color:inherit;
    }

    .hint{
      margin-top:8px; color:var(--muted); font-size:.9rem; text-align:center;
    }

    /* BAR BAWAH (ZIP, BERSIHKAN) */
    .actions{
      display:flex; gap:10px; justify-content:center; margin-top:16px;
      flex-wrap:wrap;
    }

    /* OUTPUT */
    #output{margin-top:22px; display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    canvas{width:100%; border:1px solid #e5e7eb; border-radius:10px}
    a.download-link{
      display:inline-block; text-decoration:none; background:var(--accent-2); color:#fff;
      padding:8px 12px; border-radius:10px; margin-top:8px; text-align:center; width:100%;
    }

    /* RESPONSIVE */
    @media (max-width:700px){
      .bar{grid-template-columns:1fr}
      .options-grid{grid-template-columns:1fr 1fr}
    }
    @media (max-width:480px){
      .options-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <h1>üåü File Converter Pro</h1>
    <p class="lead">Konversi file di browser: PDF ‚áÑ Gambar, TXT ‚á¢ PDF, Gabung/Pisah/Rotate/Watermark, OCR, dll.</p>
  </header>

  <div class="container">
    <h3 style="text-align:center;margin-top:0">Pilih file untuk dikonversi</h3>

    <div class="bar">
      <div class="control">
        <input type="file" id="fileInput" multiple/>
      </div>
      <select id="convertType">
        <option value="pdf2png">PDF ‚ûú PNG (per halaman)</option>
        <option value="txt2pdf">TXT ‚ûú PDF</option>
        <option value="imgConvert">Gambar ‚ûú JPG/PNG/WebP/HEIC</option>
        <option value="imgCompress">Kompres Gambar</option>
        <option value="jpg2png">JPG ‚ûú PNG (cepat)</option>
        <option value="png2jpg">PNG ‚ûú JPG (cepat)</option>
        <option value="pdfMerge">Gabung beberapa PDF</option>
        <option value="pdfSplit">Pisah PDF (rentang halaman)</option>
        <option value="pdfRotate">Rotate halaman PDF</option>
        <option value="pdfWatermark">Watermark teks di PDF</option>
        <option value="pdfExtractImages">Ekstrak halaman PDF ‚Üí PNG</option>
        <option value="ocrImage">OCR Gambar ‚Üí Teks (beta)</option>
      </select>
      <button class="btn" id="convertBtn">Konversi Sekarang</button>
    </div>

    <!-- Opsi dinamis muncul di sini -->
    <div id="options"></div>

    <div class="hint">Tips: bisa pilih banyak file. Klik <b>‚ÄúZip Hasil‚Äù</b> untuk mengunduh sekaligus.</div>

    <div class="actions">
      <button class="btn outline" id="zipBtn" title="Kumpulkan semua hasil jadi satu ZIP">Zip Hasil</button>
      <button class="btn secondary" id="clearBtn" title="Bersihkan area hasil">Bersihkan</button>
    </div>

    <div id="output"></div>
  </div>

  <script>
    // ===== Helpers UI =====
    const $ = (q,root=document)=>root.querySelector(q);
    const output = $('#output'); const options = $('#options');
    const zip = new JSZip();
    const pad = (n, scheme) => (scheme + n).slice(-scheme.length);
    const parseRanges = (str, max)=>{
      if(!str) return Array.from({length:max},(_,i)=>i+1);
      const s=new Set();
      for(const part of str.split(',')){
        if(part.includes('-')){ let [a,b]=part.split('-').map(n=>parseInt(n.trim(),10));
          if(isNaN(a)||isNaN(b)) continue; if(a>b) [a,b]=[b,a]; for(let i=a;i<=b;i++) s.add(i);
        }else{ const n=parseInt(part.trim(),10); if(!isNaN(n)) s.add(n); }
      }
      return Array.from(s).filter(n=>n>=1&&(!max||n<=max)).sort((a,b)=>a-b);
    }
    const createLink=(blobOrUrl,name,previewEl)=>{
      const wrap=document.createElement('div');
      if(previewEl) wrap.appendChild(previewEl);
      const a=document.createElement('a');
      a.className='download-link'; a.download=name;
      a.href = blobOrUrl instanceof Blob ? URL.createObjectURL(blobOrUrl) : blobOrUrl;
      a.textContent = `‚¨áÔ∏è ${name}`;
      wrap.appendChild(a); output.appendChild(wrap);
    }

    // ===== Opsi Dinamis (tanpa tumpang tindih) =====
    const renderOptions=()=>{
      const type=$('#convertType').value;
      let html='';
      const wrapStart = '<div class="options-grid">';
      const wrapEnd = '</div>';

      if(type==='pdf2png'){
        html = wrapStart +
          '<div class="field"><label>Skala render</label><input id="scale" type="number" value="2" step="0.5" min="0.5"/></div>'+
          '<div class="field"><label>Halaman (mis. 1-3,5)</label><input id="pageRange" type="text" placeholder="kosong = semua"/></div>'+
          '<div class="field"><label>Nama dasar</label><input id="baseName" type="text" value="halaman"/></div>' +
          wrapEnd;
      } else if(type==='txt2pdf'){
        html = wrapStart +
          '<div class="field"><label>Ukuran font</label><input id="fontSize" type="number" value="12" min="8" max="32"/></div>'+
          '<div class="field"><label>Margin (mm)</label><input id="margin" type="number" value="15" min="5" max="40"/></div>'+
          '<div class="field"><label>Orientasi</label><select id="orientation"><option value="p">Potret</option><option value="l">Lanskap</option></select></div>' +
          wrapEnd;
      } else if(type==='imgConvert' || type==='imgCompress'){
        html = wrapStart +
          '<div class="field"><label>Format keluaran</label><select id="imgFormat"><option value="image/jpeg">JPG</option><option value="image/png" selected>PNG</option><option value="image/webp">WEBP</option></select></div>'+
          '<div class="field"><label>Kualitas (JPG/WEBP)</label><input id="quality" type="number" value="0.92" step="0.02" min="0.2" max="1"/></div>'+
          '<div class="field"><label>Lebar px (0 = asli)</label><input id="width" type="number" value="0" min="0"/></div>' +
          wrapEnd;
      } else if(type==='pdfSplit'){
        html = wrapStart + '<div class="field" style="grid-column:1/-1"><label>Rentang (mis. 1-3,5)</label><input id="splitRanges" type="text" placeholder="contoh: 1-2,4"/></div>' + wrapEnd;
      } else if(type==='pdfRotate'){
        html = wrapStart +
          '<div class="field"><label>Derajat</label><select id="rotateDeg"><option>90</option><option>180</option><option>270</option></select></div>'+
          '<div class="field"><label>Halaman (kosong = semua)</label><input id="rotPages" type="text"/></div>' +
          wrapEnd;
      } else if(type==='pdfWatermark'){
        html = wrapStart +
          '<div class="field"><label>Teks watermark</label><input id="wmText" type="text" value="CONFIDENTIAL"/></div>'+
          '<div class="field"><label>Opacity (0‚Äì1)</label><input id="wmOpacity" type="number" value="0.15" step="0.05" min="0.05" max="1"/></div>' +
          wrapEnd;
      } else {
        html=''; // tipe lain tidak butuh opsi
      }
      options.innerHTML = html; // ‚Üê opsi selalu di wadah sendiri ‚Üí tidak tumpang tindih
    }
    $('#convertType').addEventListener('change',renderOptions);
    renderOptions();

    // ===== ZIP & CLEAR =====
    $('#zipBtn').addEventListener('click', async ()=>{
      if(Object.keys(zip.files).length===0){ alert('Belum ada file hasil.'); return; }
      const blob = await zip.generateAsync({type:'blob'}); saveAs(blob,'hasil_konversi.zip');
    });
    $('#clearBtn').addEventListener('click', ()=>{ output.innerHTML=''; zip.files={}; });

    // ===== LOGIKA KONVERSI (ringkas, sama dengan sebelumnya) =====
    document.getElementById('convertBtn').addEventListener('click', async ()=>{
      const type = $('#convertType').value;
      const fileInput = $('#fileInput');
      output.innerHTML = '';
      if(!fileInput.files.length){ alert('Pilih dulu file-nya!'); return; }
      const files = fileInput.files;

      try{
        if (type === 'pdf2png') {
          for (const f of files){
            const typedarray = new Uint8Array(await f.arrayBuffer());
            const pdf = await pdfjsLib.getDocument({data:typedarray}).promise;
            const scale = parseFloat($('#scale')?.value||'2');
            const base = $('#baseName')?.value || 'halaman';
            const pages = parseRanges($('#pageRange')?.value, pdf.numPages);
            for (const p of pages){
              const page = await pdf.getPage(p);
              const viewport = page.getViewport({ scale });
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');
              canvas.height = viewport.height; canvas.width = viewport.width;
              await page.render({ canvasContext: context, viewport }).promise;
              const blob = await new Promise(res=>canvas.toBlob(res,'image/png'));
              const name = `${base}_${pad(p,'000')}.png`;
              zip.file(name, blob); createLink(blob, name, canvas);
            }
          }
        }
        else if (type === 'txt2pdf') {
          const { jsPDF } = window.jspdf;
          for (const [idx,f] of Array.from(files).entries()){
            const text = await f.text();
            const fontSize = parseInt($('#fontSize')?.value||'12',10);
            const margin = parseInt($('#margin')?.value||'15',10);
            const orient = $('#orientation')?.value==='l'?'l':'p';
            const doc = new jsPDF({orientation:orient, unit:'mm', format:'a4'});
            doc.setFontSize(fontSize);
            const pageWidth = doc.internal.pageSize.getWidth();
            const usable = pageWidth - margin*2;
            const lines = doc.splitTextToSize(text, usable);
            let y = margin; const lineHeight = fontSize * 0.5 + 2;
            lines.forEach(ln=>{ if(y>doc.internal.pageSize.getHeight()-margin){doc.addPage();y=margin} doc.text(ln, margin, y); y+=lineHeight; });
            const blob = doc.output('blob');
            const name = `${f.name.replace(/\.[^.]+$/,'') || 'file'}_${pad(idx+1,'000')}.pdf`;
            zip.file(name, blob); createLink(blob, name);
          }
        }
        else if (type === 'imgConvert' || type === 'imgCompress' || type==='jpg2png' || type==='png2jpg') {
          const fmt = type==='jpg2png' ? 'image/png' : type==='png2jpg' ? 'image/jpeg' : ($('#imgFormat')?.value || 'image/png');
          const q = Math.min(1, Math.max(0.2, parseFloat($('#quality')?.value||'0.92')));
          const w = parseInt($('#width')?.value||'0',10);
          for(const [i,f] of Array.from(files).entries()){
            let srcBlob = f;
            if(/\.heic$/i.test(f.name)){ try{ srcBlob = await heic2any({blob:f, toType:'image/jpeg', quality:q}); }catch(e){ console.warn('HEIC gagal',e); continue; } }
            const dataUrl = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(srcBlob) });
            const img = new Image(); await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=dataUrl; });
            const canvas = document.createElement('canvas');
            const scale = w>0 ? (w/img.width) : 1;
            canvas.width = Math.round(img.width*scale); canvas.height = Math.round(img.height*scale);
            canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
            const blob = await new Promise(res=>canvas.toBlob(res, fmt, q));
            const ext = fmt.split('/')[1].replace('jpeg','jpg');
            const name = `${(f.name.replace(/\.[^.]+$/,''))}_${pad(i+1,'000')}.${ext}`;
            zip.file(name, blob); createLink(blob, name, canvas);
          }
        }
        else if (type === 'pdfMerge') {
          const pdfDoc = await PDFLib.PDFDocument.create();
          for(const f of files){
            const donor = await PDFLib.PDFDocument.load(await f.arrayBuffer());
            const copied = await pdfDoc.copyPages(donor, donor.getPageIndices());
            copied.forEach(p=>pdfDoc.addPage(p));
          }
          const out = await pdfDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
          createLink(blob, 'gabungan.pdf'); zip.file('gabungan.pdf', blob);
        }
        else if (type === 'pdfSplit') {
          if(files.length!==1){ alert('Pilih 1 file PDF untuk dipisah.'); return; }
          const src = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
          const total = src.getPageCount();
          const ranges = parseRanges($('#splitRanges')?.value, total);
          const chunks=[]; let cur=[]; let prev=null;
          for(const p of ranges){ if(prev===null||p===prev+1){cur.push(p-1)} else {chunks.push(cur); cur=[p-1]} prev=p } if(cur.length) chunks.push(cur);
          let idx=1; for(const ch of chunks){
            const outDoc = await PDFLib.PDFDocument.create();
            const copied = await outDoc.copyPages(src, ch); copied.forEach(p=>outDoc.addPage(p));
            const out = await outDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
            const name = `split_${pad(idx++,'000')}.pdf`; zip.file(name, blob); createLink(blob, name);
          }
        }
        else if (type === 'pdfRotate') {
          if(files.length!==1){ alert('Pilih 1 file PDF.'); return; }
          const deg = parseInt($('#rotateDeg')?.value||'90',10);
          const pagesSel = parseRanges($('#rotPages')?.value);
          const pdfDoc = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
          const pages = pdfDoc.getPages();
          pages.forEach((p,idx)=>{ const n=idx+1; if(!pagesSel.length || pagesSel.includes(n)){ p.setRotation(PDFLib.degrees(((p.getRotation().angle||0)+deg)%360)); }});
          const out = await pdfDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
          createLink(blob, 'rotated.pdf'); zip.file('rotated.pdf', blob);
        }
        else if (type === 'pdfWatermark') {
          if(files.length!==1){ alert('Pilih 1 file PDF.'); return; }
          const text = $('#wmText')?.value || 'CONFIDENTIAL';
          const opacity = Math.max(0.05, Math.min(1, parseFloat($('#wmOpacity')?.value||'0.15')));
          const pdfDoc = await PDFLib.PDFDocument.load(await files[0].arrayBuffer());
          pdfDoc.getPages().forEach(p=>{ const {width,height}=p.getSize(); p.drawText(text,{x:width/4,y:height/2,size:48,rotate:PDFLib.degrees(-30),color:PDFLib.rgb(0.2,0.2,0.2),opacity}); });
          const out = await pdfDoc.save(); const blob = new Blob([out],{type:'application/pdf'});
          createLink(blob, 'watermarked.pdf'); zip.file('watermarked.pdf', blob);
        }
        else if (type === 'pdfExtractImages') {
          for (const f of files){
            const buf = await f.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data:new Uint8Array(buf)}).promise;
            for(let i=1;i<=pdf.numPages;i++){
              const page = await pdf.getPage(i);
              const viewport = page.getViewport({ scale: 2 });
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.height = viewport.height; canvas.width = viewport.width;
              await page.render({ canvasContext: ctx, viewport }).promise;
              const blob = await new Promise(res=>canvas.toBlob(res,'image/png'));
              const name = `page_${pad(i,'000')}.png`; zip.file(name, blob); createLink(blob, name, canvas);
            }
          }
        }
        else if (type === 'ocrImage') {
          for(const [i,f] of Array.from(files).entries()){
            const { data } = await Tesseract.recognize(f, 'eng+ind');
            const txtBlob = new Blob([data.text],{type:'text/plain'});
            const name = `ocr_${pad(i+1,'000')}.txt`; zip.file(name, txtBlob); createLink(txtBlob, name);
          }
        }
      }catch(e){ console.error(e); alert('Terjadi kesalahan. Cek konsol (F12).'); }
    });
  </script>
</body>
</html>
